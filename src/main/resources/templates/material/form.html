<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko" th:with="isCreate=${mode=='create'}">
<head>
    <meta charset="UTF-8"/>
    <title th:text="${isCreate} ? '자재 등록' : '자재 수정'">자재 폼</title>
    <style>
        form{max-width:520px} label{display:block;margin:10px 0 4px}
        input,button{width:100%;padding:10px;box-sizing:border-box}
        .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    </style>
</head>
<body>
<h1 th:text="${isCreate} ? '자재 등록' : '자재 수정'">자재 폼</h1>
<p><a href="/materials">← 목록</a></p>

<form id="f" onsubmit="submitForm(event)">
    <input type="hidden" id="materialId" th:value="${material.id}">

    <label>코드</label>
    <input id="code"
           th:value="${material.code}"
           th:attr="readonly=${!isCreate} ? 'readonly' : null"
           required>

    <label>자재명</label>
    <input id="name" th:value="${material.name}" required>

    <div class="row">
        <div>
            <label>단위</label>
            <input id="unit" th:value="${material.unit}" placeholder="개/BOX 등">
        </div>
        <div>
            <label>재고</label>
            <input id="stockQuantity" type="number" min="0" step="1" th:value="${material.stockQuantity}">
        </div>
    </div>

    <button type="submit" style="margin-top:14px" th:text="${isCreate} ? '등록' : '저장'">저장</button>
</form>

<script th:inline="javascript">
    const isCreate = /*[[${mode=='create'}]]*/ true;

    document.addEventListener('DOMContentLoaded', async ()=>{
        if(!isCreate){
            const code = document.getElementById('code').value;
            if(!code){
                const id = Number(document.getElementById('materialId').value||0);
                if(id>0){
                    const res = await fetch('/api/materials');
                    if(res.ok){
                        const list = await res.json();
                        const m = list.find(x=>x.id===id);
                        if(m){
                            document.getElementById('code').value = m.code ?? '';
                            document.getElementById('name').value = m.name ?? '';
                            document.getElementById('unit').value = m.unit ?? '';
                            document.getElementById('stockQuantity').value = m.stockQuantity ?? 0;
                        }
                    }
                }
            }
        }
    });

    function getBody(){
        return {
            code: document.getElementById('code').value.trim(),
            name: document.getElementById('name').value.trim(),
            unit: document.getElementById('unit').value.trim(),
            stockQuantity: Number(document.getElementById('stockQuantity').value||0)
        };
    }

    async function submitForm(e){
        e.preventDefault();
        const id = document.getElementById('materialId').value;
        const url = isCreate ? '/api/materials' : `/api/materials/${id}`;
        const method = isCreate ? 'POST' : 'PUT';

        const res = await fetch(url, {
            method,
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(getBody())
        });
        if(res.ok) location.href = '/materials';
        else alert('저장 실패');
    }
</script>
</body>
</html>
