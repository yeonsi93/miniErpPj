<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>자재 목록</title>
    <style>
        table{border-collapse:collapse;width:100%}
        th,td{border:1px solid #ccc;padding:8px;text-align:center}
        .toolbar{display:flex;gap:8px;margin-bottom:10px;align-items:center;flex-wrap:wrap}
        .actions a{margin:0 4px}
        .spacer{flex:1}
    </style>
</head>
<body>
<h1>자재 목록</h1>
<p><a href="/materials/new">+ 새 자재 등록</a></p>

<div class="toolbar">
    <input id="q" placeholder="코드/이름 검색">
    <input id="minStock" type="number" placeholder="수량 ≥" style="width:110px">
    <input id="maxStock" type="number" placeholder="수량 ≤" style="width:110px">
    <input id="unit" placeholder="단위(예: 박스)">
    <button onclick="load()">조회</button>

    <div class="spacer"></div>

    <button onclick="downloadTemplate()">템플릿 다운로드</button>
    <button onclick="exportExcel()">엑셀 다운로드</button>
    <label>
        엑셀 업로드 <input type="file" id="excelFile" accept=".xlsx" onchange="uploadExcel(this)">
    </label>
</div>

<table id="tbl">
    <thead>
    <tr>
        <th>ID</th><th>코드</th><th>이름</th>
        <th>단위</th><th>재고</th><th>카테고리</th><th>등록일</th><th>작업</th>
    </tr>
    </thead>
    <tbody>
    <tr><td colspan="8">데이터 로딩 중...</td></tr>
    </tbody>
</table>

<script>
    function qs() {
        const p = new URLSearchParams();
        const q = document.getElementById('q').value.trim();
        const unit = document.getElementById('unit').value.trim();
        const minStock = document.getElementById('minStock').value;
        const maxStock = document.getElementById('maxStock').value;
        if(q) p.set('q', q);
        if(unit) p.set('unit', unit);
        if(minStock) p.set('minStock', minStock);
        if(maxStock) p.set('maxStock', maxStock);
        return p.toString();
    }

    async function load(){
        const tbody = document.querySelector('#tbl tbody');
        tbody.innerHTML = `<tr><td colspan="8">조회 중...</td></tr>`;
        const res = await fetch('/api/materials/search?'+qs());
        if(!res.ok){ tbody.innerHTML = `<tr><td colspan="8">불러오기 실패</td></tr>`; return; }
        const rows = await res.json();
        if(rows.length===0){ tbody.innerHTML = `<tr><td colspan="8">데이터 없음</td></tr>`; return; }
        tbody.innerHTML = rows.map(m=>`
      <tr>
        <td>${m.id}</td>
        <td>${m.code}</td>
        <td>${m.name}</td>
        <td>${m.unit||''}</td>
        <td>${m.stockQuantity??0}</td>
        <td>${m.category||''}</td>
        <td>${(m.createdAt||'').toString().replace('T',' ').slice(0,16)}</td>
        <td class="actions">
          <a href="/materials/${m.id}/edit">수정</a>
          <a href="/materials/${m.id}/history">히스토리</a>
          <a href="/materials/${m.id}/receive">입고</a>
          <a href="/materials/${m.id}/release">출고</a>
          <a href="#" onclick="del(${m.id});return false;">삭제</a>
        </td>
      </tr>`).join('');
    }

    function exportExcel(){
        location.href = '/api/materials/export?'+qs();
    }
    function downloadTemplate(){
        location.href = '/api/materials/template';
    }
    async function uploadExcel(input){
        const f = input.files[0];
        if(!f) return;
        const fd = new FormData();
        fd.append('file', f);
        const res = await fetch('/api/materials/upload', { method:'POST', body: fd });
        if(res.ok){
            try {
                const rpt = await res.json();
                alert(`업로드 완료\n추가: ${rpt.inserted}  수정: ${rpt.updated}  스킵: ${rpt.skipped}`);
            } catch { alert('업로드 완료'); }
            load();
        } else {
            alert('업로드 실패');
        }
        input.value = '';
    }

    async function del(id){
        if(!confirm('정말 삭제하시겠어요?')) return;

        try{
            const res = await fetch(`/api/materials/${id}`, { method:'DELETE' });
            if(res.ok){
                alert('삭제 완료');
                load();
            }else{
                const msg = await res.text().catch(()=> '삭제 실패');
                alert(msg || '삭제 실패');
            }
        }catch(e){
            alert('네트워크 오류로 삭제에 실패했습니다.');
        }
    }

    document.addEventListener('DOMContentLoaded', load);
</script>
</body>
</html>
