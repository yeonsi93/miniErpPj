<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>대시보드</title>
    <style>
        body{font-family:system-ui,apple-system,Segoe UI,Roboto;margin:20px}
        .row{
            display:grid;
            grid-template-columns: repeat(3, minmax(280px, 1fr));
            gap:20px;
            align-items:stretch;
        }
        .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
        h3{margin:0 0 12px 0;font-size:18px}
        canvas{max-width:100%;height:320px}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<h1>대시보드</h1>
<p><a href="/materials">← 자재 목록</a></p>

<div class="row">
    <div class="card">
        <h3>재고 상위 Top 10</h3>
        <canvas id="topStock"></canvas>
    </div>

    <div class="card">
        <h3>최근 30일 입·출고 추세</h3>
        <canvas id="dailyHistory"></canvas>
    </div>

    <div class="card">
        <h3>카테고리별 재고 비율</h3>
        <canvas id="categoryStock"></canvas>
    </div>
</div>

<script>
    async function jget(url){
        const r = await fetch(url);
        if(!r.ok) throw new Error(url);
        return r.json();
    }

    async function render(){
        // 1) Top Stock (막대)
        const top = await jget('/api/metrics/top-stock?limit=10');
        new Chart(document.getElementById('topStock'), {
            type: 'bar',
            data: {
                labels: top.map(x => `${x.code} ${x.name}`),
                datasets: [{ label: '재고', data: top.map(x => x.stockQuantity) }]
            },
            options: { responsive:true, plugins:{ legend:{ display:false } } }
        });

        // 2) 최근 30일 입·출고 (선)
        const daily = await jget('/api/metrics/history/daily?days=30');
        new Chart(document.getElementById('dailyHistory'), {
            type: 'line',
            data: {
                labels: daily.map(d => d.date),
                datasets: [
                    { label:'입고', data: daily.map(d => d.receive), tension:0.25 },
                    { label:'출고', data: daily.map(d => d.release), tension:0.25 }
                ]
            },
            options: { responsive:true }
        });

        // 3) 카테고리별 재고 (도넛)
        const cats = await jget('/api/metrics/category/stock');
        new Chart(document.getElementById('categoryStock'), {
            type: 'doughnut',
            data: {
                labels: cats.map(c => c.category || '미지정'),
                datasets: [{ data: cats.map(c => c.stock) }]
            },
            options: { responsive:true }
        });
    }

    document.addEventListener('DOMContentLoaded', render);
</script>
</body>
</html>
